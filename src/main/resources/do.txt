# /resources/docker/docker-compose.yml
version: '3.8'

services:
  master:
    container_name: master
    image: redis
    ports:
      - 6379:6379
    volumes:
      - ./conf/master:/usr/local/etc/redis
    command: redis-server /usr/local/etc/redis/redis.conf
    networks:
      - docker_redis-net

  slave-a:
    container_name: slave-a
    image: redis
    ports:
      - 7001:6379
    volumes:
      - ./conf/slave:/usr/local/etc/redis
    command: redis-server /usr/local/etc/redis/redis.conf --slaveof master 6379
    networks:
      - docker_redis-net

  slave-b:
    container_name: slave-b
    image: redis
    ports:
      - 7002:6379
    volumes:
      - ./conf/slave:/usr/local/etc/redis
    command: redis-server /usr/local/etc/redis/redis.conf --slaveof master 6379
    networks:
      - docker_redis-net

  sentinel:
    container_name: redis-sentinel
    image: redis
    ports:
      - 26379:26379
    volumes:
      - ./conf/sentinel:/usr/local/etc/redis
    command: redis-server /usr/local/etc/redis/sentinel.conf --sentinel
    networks:
      - docker_redis-net

networks:
  docker_redis-net:
    driver: bridge


# docker network inspect redis-net

##
# redis.conf /resources/docker/conf/slave/redis.conf
port 6379
bind 0.0.0.0
protected-mode no
appendonly yes
appendfsync everysec


# redis.conf /resources/docker/conf/master/redis.conf
port 6379
bind 0.0.0.0
protected-mode noC
appendonly yes
appendfsync everysec


# /resources/docker/conf/sentinel/sentinel.conf
# sentinel.conf

port 26379
dir /tmp

# 마스터를 모니터링할 이름, 마스터 서비스 이름(master), 마스터 포트, 퀴럼 수
sentinel monitor mymaster master 6379 2

# 마스터 장애 판단 시간 (밀리초)
sentinel down-after-milliseconds mymaster 5000

# 동기화할 수 있는 슬레이브 수 (동시 승격 가능 슬레이브 수)
sentinel parallel-syncs mymaster 1

# 장애 발생 후 타임아웃 설정
sentinel failover-timeout mymaster 10000
